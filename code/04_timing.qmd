---
title: "Analyzing developmental stage composition"
subtitle: "with multivariate GLM (manyglm)"
author: "Sarah Tanja"
date: 08/27/2025
date-modified: today
format:
  gfm: 
    toc: true
    number-sections: true
  html:
    theme: journal
    highlight-style: github
    page-layout: article
    code-background: true
    code-tools: 
      source: true
      toggle: true
    toc: true
    toc-depth: 2
    toc-location: left
    number-sections: true
    df-print: kable
    smooth-scroll: true
    link-external-icon: true
    link-external-newwindow: true
    reference-location: margin
    citation-location: margin
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, # Display code chunks
  eval = TRUE, # Evaluate code chunks
  warning = FALSE, # Hide warnings
  message = FALSE, # Hide messages
  comment = "" # Prevents appending '##' to beginning of lines in code output)
 )        
```

# Background


# Setup

## Load libraries

```{r}
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(betareg)
library(gamlss)
library(MASS) # for multinomial or negative binomial GLM
library(glmmTMB)
library(performance)
library(DHARMa)
library(mvabund)
library(scales)
library(AER) # for dispersiontest
```

## Load data

```{r}
tidy_vials <- read.csv("../output/tidy_vials.csv")
```

```{r}
tidy_timing <- tidy_vials %>% 
  dplyr::select(sample_id, treatment, hpf, date, n_egg, n_cleavage, n_morula, n_prawnchip, n_earlygastrula)
```

```{r, eval=FALSE}
write_csv(tidy_timing, "../output/tidy_timing.csv")
```

## Set colors
```{r}
stage.5.colors <- c(egg = "#FFE362",
                    cleavage = "#EBA600", 
                    morula = "#E6AA83",
                    prawnchip = "#D9685B", 
                    earlygastrula = "#A2223C")
```

# Explore the data
Check out raw count data...

```{r}
# Pivot to long format
long_tidy_counts <- tidy_timing %>%
  pivot_longer(
    cols = starts_with("n"),
    names_to = c(".value", "stage"),
    names_pattern = "(n)_(.*)"
  ) %>% 
  mutate(
    hpf = factor(hpf, 
                 levels = c(4, 9, 14), ordered = TRUE),
    stage = factor(stage, 
                   levels = c("egg", "cleavage", "morula", 
                  "prawnchip", "earlygastrula"), ordered = TRUE),
    treatment = factor(treatment, 
                       levels = c("control", "low", "mid", "high"), 
                       ordered = TRUE))

head(long_timing_counts)
```

```{r}
summary(long_timing_counts$n)
mean(long_timing_counts$n)
var(long_timing_counts$n)

hist(long_timing_counts$n, breaks = 30)
```


#### Overdispersion
- The variance (45.0) is greater than the mean (3.5), indicating that our data has overdispersion. 
```{r}
mod_pois <- glm(n ~ treatment * hpf_factor, data=long_timing_counts, family=poisson)
dispersiontest(mod_pois)
```


#### Zero-inflation
- Most of the values are 0! Visually, we can see there are lots of zeros in our data due to our experimental structure. The following code displays the proportion of total zeros for each stage (across treatment and hpf):

```{r}
long_timing_counts %>%
  group_by(stage) %>%
  summarize(prop_zero = mean(n == 0))
```

More than 50% of the counts for each stage are zeros....That's a lot of zeros!... Our data is zero-inflated.


# Statistical approach
How do we run a statistical test to answer: "Does the distribution of embryos across stages differ by treatment at each time point?" 

Our data is as follows:
One categorical response per embryo  
5 categories: egg, cleavage, morula, prawnchip, early gastrula
Exactly one category per embryo (categories are mutually exclusive)
Counted per vial, grouped by treatment & hpf
So per vial we have a composition of counts:
n_egg, n_cleavage, n_morula, n_prawnchip, n_early_gastrula
Counts represent developmental stage composition 
Counts do not sum to a total per vial (since embryos can die, etc.)

We can either model **counts** with a `Multinomial negative binomial`, or **proportions** of stage composition with a `Dirichlet regression`.

#### Should we use Dirichlet? 
A Dirichlet or beta-multinomial regression on proportions asks â€œDoes PVC shift developmental stage composition?â€ HOWEVER, the Dirichlet distribution requires strictly positive proportions (all > 0 and summing to 1). Zero counts violate that assumption because proportions of zero imply complete absence of a category â€” and Dirichlet cannot model that. We would need to subset our data by timepoint and run a Dirichlet for each, only including the non-zero stages at each timepoint (ex. at 4 hpf there are 0 embryos in the early gastrula stage, so we would need to exclude that category from the model). We also considered Dirichlet regression for stage composition analysis; however, several stage categories were biologically absent at early time points (e.g., no gastrula at 4 hpf), violating the requirement for strictly positive proportions. Therefore, manyglm with a negative binomial distribution was selected as a more appropriate method that accommodates structural zeros and overdispersion while analyzing all time points concurrently. 

#### Should we use Multinomial NB?
A Multinomial negative binomial on counts asks â€œDoes PVC leachate shift developmental stage counts, accounting for overdispersion and excess zeros?â€ HOWEVER, Multinomial models (including beta-multinomial and multinomial negative binomial) assume:
- One response column,
- Each trial falls into one of several categories,
- Total number of trials is fixed or modeled separately,
- Categories must sum to 1 (or N),
- Variance is usually fixed or only weakly overdispersed unless modeled Bayes/anova style.

But your embryos do not meet those assumptions:

| Violation                                             | Why                                                          |
| ----------------------------------------------------- | ------------------------------------------------------------ |
| Counts do **not sum to a fixed total**                | Viable embryos vary across vials                             |
| Some stages **do not exist at certain timepoints**    | Multinomial cannot handle biologically impossible categories |
| Counts are **strongly overdispersed & zero-inflated** | Requires negative binomial + mvabund handling                |
| We need **joint + stage-specific tests**              | Multinomial only gives global odds ratios                    |
ðŸŒ¿ Biological implications
Multinomial regression answers:
> â€œWhat is the probability of each category relative to others?â€

But our question is different:
> â€œDo counts in each developmental stage change with treatment and time â€” and does PVC shift the overall composition of development?â€

Since development is sequential, not competitive (like elections or consumer choice),
multinomial structure is biologically misleading.

> We considered multinomial negative binomial models but rejected them because our data represent separate count variables rather than a single categorical response, and because developmental stages do not form a fixed-sum composition at all timepoints. Instead, we used a multivariate generalized linear model (manyglm, negative binomial), which accommodates overdispersion, structural zeros, and allows testing both overall shifts in developmental composition and stage-specific responses.

#### Should we use Multivariate GLM?
âœ” Handles overdispersed count data
âœ” Allows structural zeros
âœ” Models all stages simultaneously
âœ” Provides multivariate AND univariate tests
âœ” Allows interaction (treatment Ã— hpf) without splitting data
âœ” Allows rich residual diagnostics (e.g., via DHARMa)




# Visualize counts 

```{r}
# Create the faceted bar plot
ggplot(long_timing_counts, aes(x = stage, y = n, fill = stage, group = treatment)) +
  geom_col(position = "stack", alpha = 0.8) +
  facet_wrap(~ hpf_factor, ncol = 1) +  # Optional: separate plots by treatment
  labs(title = "Embryo counts by stage over time by treatment",
       x = "Hours post-fertilization (hpf)",
       y = "Embryo count") +
  theme_minimal() +
  scale_fill_manual(values = stage.5.colors) 
```
```{r}
ggplot(long_timing_counts, aes(x = treatment, y = n, fill = stage)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ hpf_factor) +
  labs(title = "Embryo stage counts by treatment over time",
       x = "Treatment",
       y = "Embryo count") +
  theme_minimal() +
  scale_fill_manual(values = stage.5.colors)
```
> At 4 hpf, the majority of embryos are indeed in the egg or early cleavage stages, and very few or none are in advanced stages like prawnchip or early gastrula. As time progresses to 9 and then 14 hpf, the embryo counts in the earlier stages (egg, cleavage) decrease, reflecting development progression, while counts in the later stages (prawnchip, early gastrula) increase correspondingly. You can see that total counts across treatments appear similar, as well as the stage breakdown within each treatment. 

## Mean stage composition counts table
```{r}
stage_levels <- c("egg", "cleavage", "morula", "prawnchip", "earlygastrula")
treat_levels <- c("control", "low", "mid", "high")
hpf_levels   <- c(4, 9, 14)

table_stage_count <- counts_summary %>%
  filter(stage %in% stage_levels) %>%
  mutate(
    stage     = factor(stage,     levels = stage_levels),
    treatment = factor(treatment, levels = treat_levels),
    hpf       = factor(hpf,       levels = hpf_levels)
  ) %>%
  dplyr::select(stage, hpf, treatment, mean_counts) %>%
  pivot_wider(
    names_from  = c(treatment, hpf),
    values_from = mean_counts,
    values_fill = 0,
    # column names like "4 hpf - control"
    names_glue  = "{hpf} hpf - {treatment}"
  ) %>%
  dplyr::select(stage, 
                `4 hpf - control`, `4 hpf - low`, `4 hpf - mid`, `4 hpf - high`,
                `9 hpf - control`, `9 hpf - low`, `9 hpf - mid`, `9 hpf - high`,
                `14 hpf - control`, `14 hpf - low`, `14 hpf - mid`, `14 hpf - high`) %>%
  arrange(stage) %>%
  # turn to % (numeric) for nice formatting
  mutate(across(-stage, ~ round(.x, 1))) %>%
  rename(Stage = stage) 


table_stage_count
```

```{r}
library(sjPlot)

sjPlot::tab_df(
  table_stage_count,
  title         = "Mean stage composition (counts of embryos) by treatment and developmental time (hpf)",
  show.rownames = FALSE,
  digits        = 1
)
```

```{r, eval=FALSE}
library(stargazer)

stargazer::stargazer(
  table_stage_count,
  type      = "html",  # or "latex" if knitting to PDF
  summary   = FALSE,
  rownames  = FALSE,
  digits    = 1,
  title     = "Mean stage composition (counts of embryos) by treatment and developmental time (hpf)",
  out       = "../tables/table_stage_composition_counts.doc"  # optional
)

```



# Visualize proportions

Drop the samples with zero embryos (drop zeros)
```{r}
tidy_vials_dropz <- tidy_vials %>% 
  filter(sample_id != c("3L9", "7H9"))%>% 
  mutate(treatment = factor(treatment, levels = c("control",
                                                  "low",
                                                  "mid",
                                                  "high"))) %>% 
  mutate(hpf = factor(hpf, levels = c("4",
                                      "9",
                                      "14")))
```

Calculate proportion means
```{r}
# Step 1: Pivot to long format
long_tidy_vials <- tidy_vials_dropz %>%
  pivot_longer(
    cols = starts_with("prop") | starts_with("n"),
    names_to = c(".value", "stage"),
    names_pattern = "(prop|n)_(.*)"
  )

# Step 2: Calculate mean proportions for each stage within each treatment
prop_summary <- long_tidy_vials %>%
  group_by(treatment, stage, hpf) %>%
  summarize(mean_prop = mean(prop), .groups = "drop") %>% 
  filter(stage != "embryos") %>% 
  filter(stage %in% 
         c("egg", 
         "cleavage", 
         "morula", 
         "prawnchip", 
         "earlygastrula")) %>% 
  mutate(stage = factor(stage, levels = c("egg", "cleavage", "morula", "prawnchip", "earlygastrula"))) %>% 
  mutate(hpf = factor(hpf, levels = c("4", "9", "14"))) %>% 
  mutate(treatment = factor(treatment, 
                        levels = c("control", "low", "mid", "high")))

head(prop_summary)
```

Save proportion summary as a csv
```{r}
write_csv(prop_summary, "../output/prop_summary.csv")
```

```{r}
prop_summary %>% 
ggplot(., aes(x = treatment, y = mean_prop, fill = stage)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = stage.5.colors) +
  ggtitle("Embryo stage composition")+
  labs(y = "", x = "Treatment", fill = "Embryonic Stage") +
  facet_wrap(~ hpf)+
  theme_minimal()+
  theme(axis.text.x = element_text(
      angle = 45,      # rotate 45Â°
      hjust = 1,       # horizontal justification
      vjust = 1        # tweak if you want
    ))
```
::: callout-note
Visually we can see there is little/no difference in proportion of embryos at each stage across treatments at each end-point (4,9,14 hpf).
:::

## Mean stage proportions table
```{r}
stage_levels <- c("egg", "cleavage", "morula", "prawnchip", "earlygastrula")
treat_levels <- c("control", "low", "mid", "high")
hpf_levels   <- c(4, 9, 14)

table_stage_pct <- prop_summary %>%
  filter(stage %in% stage_levels) %>%
  mutate(
    stage     = factor(stage,     levels = stage_levels),
    treatment = factor(treatment, levels = treat_levels),
    hpf       = factor(hpf,       levels = hpf_levels)
  ) %>%
  dplyr::select(stage, hpf, treatment, mean_prop) %>%
  pivot_wider(
    names_from  = c(treatment, hpf),
    values_from = mean_prop,
    values_fill = 0,
    # column names like "4 hpf - control"
    names_glue  = "{hpf} hpf - {treatment}"
  ) %>%
  dplyr::select(stage, 
                `4 hpf - control`, `4 hpf - low`, `4 hpf - mid`, `4 hpf - high`,
                `9 hpf - control`, `9 hpf - low`, `9 hpf - mid`, `9 hpf - high`,
                `14 hpf - control`, `14 hpf - low`, `14 hpf - mid`, `14 hpf - high`) %>%
  arrange(stage) %>%
  # turn to % (numeric) for nice formatting
  mutate(across(-stage, ~ round(.x * 100, 1))) %>%
  rename(Stage = stage) 


table_stage_pct
```

```{r}
library(sjPlot)

sjPlot::tab_df(
  table_stage_pct,
  title         = "Mean stage composition (% of embryos) by treatment and developmental time (hpf)",
  show.rownames = FALSE,
  digits        = 1
)
```

```{r, eval=FALSE}
library(stargazer)

stargazer::stargazer(
  table_stage_pct,
  type      = "html",  # or "latex" if knitting to PDF
  summary   = FALSE,
  rownames  = FALSE,
  digits    = 1,
  title     = "Mean stage composition (% of embryos) by treatment and developmental time (hpf)",
  out       = "../tables/table_stage_composition_prop.doc"  # optional
)

```

# MVABUD/ MANYGLM
```{r}
Y <- mvabund(tidy_timing[, c("n_egg", 
                           "n_cleavage", 
                           "n_morula", 
                           "n_prawnchip", 
                           "n_earlygastrula")])

mod_all <- manyglm(
  Y ~ treatment * hpf,
  family = "negative.binomial",
  data = tidy_timing
)

anova(mod_all, p.uni = "adjusted")
plot(mod_all)
```

#### Method
Developmental Stage Composition Analysis

To test whether PVC leachate altered early embryonic developmental trajectories, we quantified the number of embryos in each of five mutually exclusive developmental stagesâ€”egg, cleavage, morula, prawnchip, and early gastrulaâ€”for each vial at each time point (4, 9, and 14 hpf). Because these responses represent count-based multivariate outcomes that are likely to be overdispersed and zero-inflated, we used a multivariate generalized linear model (GLM) implemented in the mvabund package (function manyglm; Wang et al. 2012). Counts of developmental stages were modeled simultaneously as a multivariate response:

ð‘Œ
âˆ¼
treatment
Ã—
hpf
Yâˆ¼treatmentÃ—hpf

with a negative binomial error distribution, which provided a better fit than Poisson based on dispersion statistics. The full dataset (all stages Ã— all treatments Ã— hpf) was analyzed as a single multivariate response matrix, allowing us to detect both overall shifts in developmental composition and stage-specific responses. Model significance was assessed using PIT-trap resampling with 999 iterations, which robustly estimates p-values in the presence of non-normal residual structure.

We report both multivariate test statistics (testing whether overall developmental stage composition changed across treatments and/or time) and univariate tests for each individual stage. Significance of main effects and interaction terms was assessed using Analysis of Deviance (Type I tests). All analyses were performed in R (R version 4.5.1 (2025-06-13 ucrt); R Core Team) using the mvabund package (mvabund_4.2.1), with alpha set at 0.05.

#### Result
Multivariate Test (overall composition of all stages)
Term	Significance	Interpretation
- treatment	âŒ not sig	PVC does not alter overall stage composition
- hpf	â­ Highly significant	Stage composition strongly depends on developmental time
- treatment Ã— hpf	âŒ not sig	No evidence PVC modifies the trajectory of development

Therefore:
âž¡ï¸ Embryos progress through stages as expected over time (hpf is significant),
âž¡ï¸ But PVC leachate does not alter that developmental sequence.

Univariate Tests (per stage)

Across all stages, we see the same pattern:
Stage	hpf effect	treatment effect
egg	YES	NO
cleavage	YES	NO
morula	YES	NO
prawnchip	Weak / marginal	NO
gastrula	YES	NO

Interpretation:

Developmental progression from egg â†’ gastrula follows a time-dependent trajectory, but PVC does not shift embryos into or out of any specific stage at the sample size tested.

ðŸ§¾ Manuscript-Ready Summary

We used a multivariate generalized linear model (manyglm, negative binomial) to test whether PVC leachate altered the distribution of developmental stages across time (egg, cleavage, morula, prawnchip, early gastrula).

The multivariate test showed a strong effect of time (hpf) on developmental stage composition (Deviance = 441.7, p = 0.001), indicating that embryos progress through stages as expected. However, neither treatment (p > 0.99) nor treatment Ã— hpf interaction (p > 0.18) were significant.

Univariate tests confirmed that all stages were significantly affected by time, but none were significantly affected by PVC treatment.

Thus, PVC leachate did not alter developmental progression across early embryonic stages, at the concentrations tested.
