---
title: "Survival rates"
subtitle: "How many survived?"
date: 08/27/2025
date-modified: today
format:
  gfm: 
    toc: true
    number-sections: true
  html:
    theme: journal
    highlight-style: github
    page-layout: article
    code-background: true
    code-tools: 
      source: true
      toggle: true
    toc: true
    toc-depth: 2
    toc-location: left
    number-sections: true
    df-print: kable
    smooth-scroll: true
    link-external-icon: true
    link-external-newwindow: true
    reference-location: margin
    citation-location: margin
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, # Display code chunks
  eval = TRUE, # Evaluate code chunks
  warning = FALSE, # Hide warnings
  message = FALSE, # Hide messages
  comment = "" # Prevents appending '##' to beginning of lines in code output)
 )        
```

# Install packages & load libraries

```{r, eval=FALSE, include=FALSE}
#install.packages("remotes")
#remotes::install_github("wilkelab/cowplot")
#install.packages("colorspace", repos = "http://R-Forge.R-project.org")
#remotes::install_github("clauswilke/colorblindr")
#install.packages("ggbeeswarm")
```

```{r}
library(tidyverse)
library(emmeans)
library(ggplot2)
library(RColorBrewer)
library(viridis)
library(colorblindr)
library(colorspace)
library(ggbeeswarm)
library(ggrepel)
library(scales)
library(ggtext)
```

# Load in data

```{r}
tidy_vials <- read.csv("../output/tidy_vials.csv")
```

## Data prep
Set factor levels for treatment and hpf

```{r}
treat_levels <- c("control", "low", "mid", "high")
hpf_levels   <- c(4, 9, 14)          # use numeric to match numeric hpf
map_leachate <- c(control = 0, low = 0.01, mid = 0.1, high = 1)

survival <- tidy_vials %>%
  mutate(
    # ordered factors
    treatment  = factor(treatment, levels = treat_levels, ordered = TRUE),
    hpf_factor = factor(hpf, levels = hpf_levels, ordered = TRUE),

    # numeric concentration mapped from treatment (safe + explicit)
    leachate_mgL = unname(map_leachate[as.character(treatment)])
  ) %>%
  dplyr::select(sample_id, treatment, hpf, hpf_factor, leachate_mgL, n_viable)

str(survival)
```

# Visualize

```{r, fig.height=8, eval=FALSE, echo=FALSE}
display.brewer.all()
```

```{r, eval=FALSE, echo=FALSE }
display.brewer.pal(9, name = "PuRd")
display.brewer.pal(9, name = "Blues")
display.brewer.pal(9, name = "Oranges")
```

```{r}
#| include: false
# Get the three PuRd colors
leachcolors <- brewer.pal(9, "PuRd")[c(1, 2, 4, 9)]
leachcolors

# Get the four Oranges colors
hpfcolors <- brewer.pal(9, "Oranges")[c(2, 4, 6, 8)]
hpfcolors
```

```{r, include=FALSE}
leachate_colors <- c("#ABCFE2", "#8B7EC8", "#5E409D", "#31234E")
leachate_colors <- c("grey60", "#C994C7", "#980043", "#67001F")
stage_colors <- c("#FEE6CE", "#FDAE6B", "#F16913")
```

## Boxplot

```{r, fig.height=6}
# labels for legend
labs_map <- c(control = "0 (control)", low = "0.01 mg/L (low)",
              mid = "0.1 mg/L (mid)", high = "1 mg/L (high)")

box <- ggplot(survival, aes(x = hpf_factor, y = n_viable, color = treatment, fill = treatment)) +
  geom_boxplot(alpha = 0.65, outlier.shape = NA) +
  geom_beeswarm(aes(group = interaction(hpf_factor, treatment)),
                dodge.width = 0.7, priority = "density", cex = 1.2) +
  scale_fill_manual(
    name   = "PVC leachate concentration",
    values = leachate_colors,
    breaks = names(labs_map),
    labels = labs_map
  ) +
  scale_color_manual(
    name   = "PVC leachate concentration",
    values = leachate_colors,
    breaks = names(labs_map),
    labels = labs_map
  ) +
  labs(
    x = "Hours post-fertilization", y = "Viable embryo counts",
    title = "**Survival** of embryos"
  ) +
  geom_hline(yintercept = 30, linetype = "dashed") +
  scale_y_continuous(
    limits = c(0, 34), breaks = c(0, 10, 20, 30),
    sec.axis = sec_axis(~ . / 30 * 100, name = "Percent relative survival",
                        breaks = seq(0, 100, 10),
                        labels = scales::label_number(accuracy = 1, suffix = "%"))
  ) +
  theme_minimal() +
  theme(
    axis.ticks.x = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.title.position = "top",
    plot.title = element_markdown(size = 18, face = "plain")
  )

box
```

Colorblind..

```{r}
cvd_grid(box)
```

```{r}
ggsave("../plots/viablecounts_survival_boxplot.png", width = 8, height = 6, dpi = 600)
```

## Line plot

```{r}
mean_trajectories <- tidy_vials %>%
  group_by(treatment, hpf_factor) %>%
  summarise(
    mean_viable = mean(n_viable, na.rm = TRUE),
    se_viable = sd(n_viable, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

line <- ggplot(mean_trajectories, aes(x = hpf_factor, y = mean_viable, 
                               color = treatment, group = treatment)) +
  geom_line(linewidth = 1.2, alpha = 0.6) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_viable - se_viable, 
                    ymax = mean_viable + se_viable),
                width = 0.2, linewidth = 0.8) +
  scale_color_manual(values = leachate_colors) +
  labs(
    title = "Mean viable embryo trajectories over time",
    x = "Hours post-fertilization",
    y = "Mean number of viable embryos (± SE)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

line
```

Colorblind...

```{r}
cvd_grid(line)
```
## Relative survival

-   **Cross-sectional design**:\
    At each timepoint (4, 9, 14 hpf) you *sample a different subset* of embryos — i.e., you don’t track the same individuals over time. You have **counts of viable (surviving) embryos** per treatment × timepoint combination. So, at each timepoint, you can measure *proportion surviving* relative to the **starting number of embryos**

Calculate the proportionate change from one time point to the next:

Relative survival to time hpf4 = (mean embryo count at hpf4)/(mean \_eggs_per_vial) Relative survival to time hpf9 = (mean embryo count at hpf9)/(mean \_eggs_per_vial). Relative survival to time hpf14 = (mean embryo count at hpf14)/(mean \_eggs_per_vial).

We take our theoretical 'starting point' from the knowledge that a *M. cap* bundle has 15+/- 5.1 eggs. In each vial we placed 2 bundles.

```{r}
set.seed(123)  # for reproducibility

# Simulate eggs per bundle: 2 bundles per vial, 120 vials
n_vials <- 120
n_bundles <- 2 * n_vials

# Simulate egg counts per bundle
eggs_per_bundle <- rnorm(n_bundles, mean = 15, sd = 5.1)

# Optional: enforce only positive egg counts (truncated normal)
eggs_per_bundle <- pmax(round(eggs_per_bundle), 1)

# Group into vials: every two bundles go into one vial
eggs_per_vial <- rowSums(matrix(eggs_per_bundle, ncol = 2, byrow = TRUE))

# Summarize
mean_eggs_per_vial <- mean(eggs_per_vial)
sd_eggs_per_vial <- sd(eggs_per_vial)

# Output
mean_eggs_per_vial
sd_eggs_per_vial
```

::: callout-note
Here we use mean total embryos = 30, SD = 6.4 as a starting point, our 100%, that we used to compare all our counts to for relative survival
:::

```{r}
survival <- survival %>%
  mutate(relative_survival = n_viable / 30)

survival_summary <- survival %>%
  group_by(treatment, hpf) %>%
  summarise(
    mean_survival_rate = mean(relative_survival, na.rm = TRUE),
    sd_survival_rate   = sd(relative_survival, na.rm = TRUE),
    n             = n(),
    se_survival_rate   = sd_survival_rate / sqrt(n)  # optional: standard error
  )

survival_summary
```

```{r}
ggplot(survival_summary, aes(x = hpf, y = mean_survival_rate, color = treatment, group = treatment)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_survival_rate - se_survival_rate,
                    ymax = mean_survival_rate + se_survival_rate),
                width = 0.3) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    x = "Hours post-fertilization (hpf)",
    y = "Mean relative survival (±SE)",
    color = "Treatment",
    title = "Cumulative relative survival by treatment and time"
  ) +
  theme_minimal()
```
# Analyze
## Run Two-way ANOVA

Are the mean numbers of total surviving viable embryos in each treatment across time different from each other? This ANOVA ignores embryo stage (where the embryo is in terms of development) and only looks at embryos with a status that is typical or uncertain and does not model any random effects (ex. night of spawn)

```{r}
anova_result <- aov(n_viable ~ treatment * hpf_factor, data = survival)
```

Summarize the ANOVA result

```{r}
summary(anova_result)
```

## Normality
For ANOVA, it’s **the residuals** (not the raw data) that should be approximately normal.
### Q-Q plot
```{r}
plot(anova_result, which = 2)  # QQ plot
```
### Shapiro-Wilk test
```{r}
shapiro.test(residuals(anova_result))
```

```{r}
survival %>%
  group_by(hpf) %>%
  summarise(shapiro_p = shapiro.test(n_viable)$p.value)
```

::: callout-note
Shapiro Wilk Test : If p \< 0.05 the sample does not come from a normal distribution. If p \> 0.05 the sample comes from a normal distribution. Here we see our count data for each hpf come from an approximately normal distribution.
:::

Overlapping density plots

```{r}
ggplot(survival, aes(x = n_viable, fill = hpf_factor, group = hpf_factor)) +
  geom_density(alpha = 0.4) +
  labs(x = "Counts of viable embryos", y = "Density") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()
```

## Equal variance

```{r}
plot(anova_result, which = 1)
```
✅ What looks good here
The red line is nearly horizontal and centered around 0.
There’s no obvious curve or systematic trend.
Variance within each cluster of fitted values (≈ 8–15 and ≈ 25–27) looks roughly similar — no funnel shape.
Residuals are fairly symmetrically distributed above/below zero.
That means our data show no strong evidence of heteroscedasticity (variance inequality).
The ANOVA’s equal-variance assumption looks reasonably met.

⚠️ Things to keep an eye on
We have two main clusters of fitted values (≈ 10–15 vs 25–27).
That’s expected with our distinct mean embryo counts at early (4hpf) vs later (9 & 14 hpf) development.
Variances look somewhat smaller in the higher-mean cluster, but not alarmingly so.
A few labeled points (33, 87, 9) are outliers

### Inspect outliers
```{r}
survival[c(9, 33, 87), ]
```

### Levene's test
```{r}
# Levene’s test (more robust)
library(car)
leveneTest(n_viable ~ treatment * hpf_factor, data = survival)
```


## What are the means and sd's?

```{r}
# Calculate mean and SD for each hpf group
summary_data <- survival %>%
  group_by(hpf, treatment) %>%
  summarise(
    mean_embryo = mean(n_viable),
    sd_embryo = sd(n_viable),
    .groups = "drop"
  )

print(summary_data)
```


# emmeans

> Within each developmental timepoint (4, 9, 14 hpf), do mean viable-embryo counts differ among treatments?

```{r}
emmeans(anova_result, pairwise ~ treatment | hpf_factor)
```

| hpf | Treatment means (±SE) | Pattern | Tukey post-hoc contrasts |
|-------------|-------------|---------------------------------|-------------|
| **4 hpf** | Means ≈ 24–27 | All treatments roughly equal; p \> 0.6 for every pair | → no difference |
| **9 hpf** | Means ≈ 11–13 | All treatments tightly clustered; p \> 0.9 | → no difference |
| **14 hpf** | Means ≈ 9.5–14 | Slight trend: mid \> low \> control \> high, but SE = 2 and all p \> 0.36 | → no significant difference |

> Across 4, 9, and 14 hpf: The treatment effect was consistently non-significant, even within each developmental stage window. .


# Summary

> A two-way ANOVA found no significant effects of leachate treatment, developmental stage (hpf), or their interaction on the developmental index (all p \> 0.05). Pairwise Tukey comparisons within each hpf confirmed no differences among treatments (adjusted p \> 0.36). A two-way ANOVA found no significant interaction between treatment and developmental time (hpf) on embryo viability (p > 0.05). Estimated marginal means indicated similar numbers of viable embryos among treatments at 4 hpf (24–27 ± 2 SE), 9 hpf (11–13 ± 2 SE), and 14 hpf (10–14 ± 2 SE). Tukey-adjusted pairwise contrasts within each timepoint revealed no significant differences between treatments (all adjusted p > 0.36), indicating that leachate exposure did not measurably affect survival across embryonic stages.


