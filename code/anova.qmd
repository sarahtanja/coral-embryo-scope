---
title: "ANOVA"
subtitle: 
date: 04/02/2024
date-modified: today
format:
  gfm: 
    toc: true
    number-sections: true
  html:
    theme: journal
    highlight-style: github
    page-layout: article
    code-background: true
    code-tools: 
      source: true
      toggle: true
    toc: true
    toc-depth: 2
    toc-location: left
    number-sections: true
    df-print: kable
    smooth-scroll: true
    link-external-icon: true
    link-external-newwindow: true
    reference-location: margin
    citation-location: margin
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, # Display code chunks
  eval = TRUE, # Evaluate code chunks
  warning = FALSE, # Hide warnings
  message = FALSE, # Hide messages
  comment = "", # Prevents appending '##' to beginning of lines in code output)
 )        
```

# Background
We have a total of 108 samples. 
This type of data is called cross-sectional data. 

Microscopy data will be visually examined for normal distribution and homogeneity of variance. Microscopy data will be analyzed using a One-Way ANOVA, followed by a Tukey HSD post-hoc test.

# Install & Load Libraries

```{r}
library(tidyverse)
```

```{r}
tidy_bros <- read.csv("../data/output/tidy_bros.csv")
tidy_vials <- read.csv("../data/output/tidy_vials.csv")
```

# ALL EMBRYOS : counts

## Is it normal?

### Overlapping density plots

```{r}
ggplot(tidy_vials, aes(x = n_embryos, fill = hpf_factor)) +
  geom_density(alpha = 0.4) +
  labs(x = "Embryo Total", y = "Density") +
  #scale_fill_brewer(palette = "Set2") +
  theme_minimal()

```

### Q-Q plots

```{r}
ggplot(tidy_vials, aes(sample = n_embryos)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ hpf) +
  theme_minimal()

```

### Shapiro-Wilk test

```{r}
tidy_vials %>%
  group_by(hpf) %>%
  summarise(shapiro_p = shapiro.test(n_embryos)$p.value)
```

> Shapiro Wilk Test : If p \< 0.05 the sample does not come from a normal distribution. If p \> 0.05 the sample comes from a normal distribution

::: callout-important
Numbers of total surviving embryos (not looking at status or stage) for each time-point of hours post fertilization (hpf) across treatments form normal distributions.
:::

## What are the means and sd's?

```{r}
# Calculate mean and SD for each hpf group
summary_data <- tidy_vials %>%
  group_by(hpf, treatment) %>%
  summarise(
    mean_embryo = mean(n_embryos),
    sd_embryo = sd(n_embryos),
    .groups = "drop"
  )

print(summary_data)
```

## Are the means different?

Are the mean numbers of total surviving embryos in each treatment across time different from each other? This ANOVA ignores embryo status and all random effects (parentage, night of spawn)

### Two-way ANOVA by hpf and treatment

```{r}
anova_result <- aov(n_embryos ~ hpf_factor * treatment, data = tidy_vials)
```

Summarize the ANOVA result

```{r}
summary(anova_result)
```

::: callout-important
No PVC leachate treatments were found to have a significant effect on the total number of surviving embryos in each embryonic stage examined. The PVC leachate treatments were not significantly different from the control.

The number of surviving embryos in each stage is significantly different, as expected... `p = 1.36e-15` , `p < 0***`
:::

### Tukey HSD

```{r}
TukeyHSD(anova_result)
```

::: callout-important
In summary the number of embryos at the cleavage stage (4 hpf) is significantly different from the number of surviving embryos at the prawn chip (9 hpf) and early gastrula (14 hpf) stages; but the survival at 9 hpf is not significantly different from 14 hpf.
:::

# VIABLE EMBRYOS : counts

## Is it normal?

### Overlapping density plots

```{r}
ggplot(tidy_vials, aes(x = n_viable, fill = hpf_factor)) +
  geom_density(alpha = 0.4) +
  labs(x = "Counts of viable embryos", y = "Density") +
  #scale_fill_brewer(palette = "Set2") +
  theme_minimal()

ggsave("../plots/density_viable.png", width = 8, height = 6, dpi = 300)
```

### Q-Q plots

```{r}
ggplot(tidy_vials, aes(sample = n_viable)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ hpf) +
  theme_minimal()
```

### Shapiro-Wilk test

```{r}
tidy_vials %>%
  group_by(hpf) %>%
  summarise(shapiro_p = shapiro.test(n_viable)$p.value)
```

::: callout-important
The distribution of viable embryos for 9 and 14 hpf are normal, however the 4 hpf group has a binomial distribution. !This is likely an artifact of fertilized eggs that just hadn't yet begun cleavage at 4 hpf and needed a little more time to develop! How do we approach this?? The unfertilized eggs mostly disintegrate between the 4 hpf and 9 hpf time points.
:::

# 4 'Schrodinger's coral egg'

At 4 hpf most embryos are still in the 'oocyte' stage: leaving doubt as to whether they are successfully fertilized and proceeding with embryonic development or not.

## 4 hpf proceed with binomial regression ...?

::: callout-important
Here we see that the 4 hpf group has a binomial distribution! NOT a normal distribution... It seems that samples either had fertilization success, or they didn't.

Proceed to binomial regression code!!!
:::

## 9 hpf One-Way ANOVA

```{r}
anova_9 <- tidy_vials %>% 
  filter(hpf_factor == "9") %>% 
  aov(n_viable ~ treatment, data = .)

summary(anova_9)
```

Here, `data = .` ensures that the filtered data is passed properly into `aov()`.

::: callout-note
At 9 hpf there is no significant difference between the number of viable embryos found in each treatment. Treatment was found to be non-significant (p=0.959) at 9 hpf.
:::

## 14 hpf One-Way ANOVA

```{r}
anova_14 <- tidy_vials %>% 
  filter(hpf_factor == "14") %>% 
  aov(n_viable ~ treatment, data = .)

summary(anova_14)
```


