---
title: "Survival rates"
subtitle: "How many survived?"
date: 08/27/2025
date-modified: today
format:
  gfm: 
    toc: true
    number-sections: true
  html:
    theme: journal
    highlight-style: github
    page-layout: article
    code-background: true
    code-tools: 
      source: true
      toggle: true
    toc: true
    toc-depth: 2
    toc-location: left
    number-sections: true
    df-print: kable
    smooth-scroll: true
    link-external-icon: true
    link-external-newwindow: true
    reference-location: margin
    citation-location: margin
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, # Display code chunks
  eval = TRUE, # Evaluate code chunks
  warning = FALSE, # Hide warnings
  message = FALSE, # Hide messages
  comment = "" # Prevents appending '##' to beginning of lines in code output)
 )        
```

# Load libraries

```{r}
library(tidyverse)
library(emmeans)
library(ggplot2)
library(RColorBrewer)
library(viridis)
library(colorblindr)
library(colorspace)
library(ggbeeswarm)
library(ggrepel)
library(scales)
library(ggtext)
library(ggsidekick)
library(patchwork)
library(cowplot) # for draw_image
```

# Load in data

```{r}
tidy_vials <- read.csv("../output/tidy_vials.csv")
prop_summary <- read.csv("../output/prop_summary.csv")
status_summary <- read.csv("../output/status_summary.csv")
```

## Data prep
Set factor levels for treatment and hpf

```{r}
treat_levels <- c("control", "low", "mid", "high")
hpf_levels   <- c(4, 9, 14)          # use numeric to match numeric hpf
map_leachate <- c(control = 0, low = 0.01, mid = 0.1, high = 1)

survival_df <- tidy_vials %>%
  mutate(
    # ordered factors
    treatment  = factor(treatment, levels = treat_levels, ordered = TRUE),
    hpf_factor = factor(hpf, levels = hpf_levels, ordered = TRUE),

    # numeric concentration mapped from treatment (safe + explicit)
    leachate_mgL = unname(map_leachate[as.character(treatment)])
  ) %>%
  dplyr::select(sample_id, treatment, hpf, hpf_factor, leachate_mgL, n_viable)

str(survival_df)
```


## Custom ggplot theme
```{r}
theme_sleek_axe <- function() {
  theme_sleek() +
    theme(
      panel.border = element_blank(),
      axis.line.x  = element_line(color = "grey70"),
      axis.line.y  = element_line(color = "grey70"),
      plot.title = element_text(
      size  = 14,
      color = "grey40",
      hjust = 0.5,    # center
      margin = margin(b = 20) # add space BELOW title
      ),      ,       
      plot.subtitle = element_text(
      size   = 10,       # smaller than title
      colour = "grey60", # lighter grey
      hjust  = 0.5 ),      # center
      margin = margin(b = 40) # add space BELOW title
      )
}

```

## Set colors

```{r}
#colorspace::hclwizard()
```

### Leachate
Leachate options
Ocean environmental watery tones
blue-purple
```{r}
leachate_0 <- c("#B0F4FA", "#75C165", "#A96C00", "#8B0069")
leachate_1 <- c("#D5ECC0", "#6ACFBA", "#399AC2", "#80146E")
leachate_2 <- c("#E4EBD6", "#8CC4AD", "#3E909F", "#4E4E7A")
leachate_3 <- c("#DAE6FF", "#BBC7FF", "#9CA9FF", "#7D8BFF")

leachate.colors <- c(control = "#AEF1FF", 
                low = "#BBC7FF",
                mid = "#7D8BFF", 
                high = "#592F7D")
```

### Stage
Earthy stony coral tones
yellow-orange-red
```{r}
stage_0 <- c("#DCC14F", "#D89500", "#C86600")
stage_1 <- c("#DCC14F", "#9F3D2F", "#000000")
stage_2 <- c("#A2223C", "#E6AA83",  "#D9685B")
stage_3 <- c("#D9685B", "#D89500",  "#9F3D2F")
stage_4 <- c("#FFE362", "#EBA600", "#8D5300")

stage.5.colors <- c(egg = "#FFE362",
                    cleavage = "#EBA600", 
                    morula = "#E6AA83",
                    prawnchip = "#D9685B", 
                    earlygastrula = "#A2223C")
```

### Spawn night

```{r}
night_0 <- c("#FDE725", "#440154", "#21918C")
night_1 <- c("#FFCEF4", "#578B21", "#201158")
night_2 <- c("#E3FAA5", "#B16776", "#1E2440")

night.colors <- c(July_6th = "#E3FAA5", 
                  July_7th = "#578B21", 
                  July_8th = "#1E2440")
```

### Status
```{r}
status.colors <- c(typical = "#75C165", 
                   uncertain = "#E3FAA5", 
                   malformed = "#8B0069")
```

# Survival boxplot

```{r}
# labels for legend
labs_map <- c(control = "0 (FSW control)", low = "0.01 mg/L (low)",
              mid = "0.1 mg/L (mid)", high = "1 mg/L (high)")

survival <- ggplot(survival_df, aes(x = hpf_factor, y = n_viable, color = treatment, fill = treatment)) +
  geom_boxplot(alpha = 0.65, outlier.shape = NA) +
  geom_beeswarm(aes(group = interaction(hpf_factor, treatment)),
                dodge.width = 0.7, priority = "density", cex = 1.2) +
  scale_fill_manual(
    name   = "PVC leachate",
    values = leachate.colors,
    breaks = names(labs_map),
    labels = labs_map
  ) +
  scale_color_manual(
    name   = "PVC leachate",
    values = leachate.colors,
    breaks = names(labs_map),
    labels = labs_map
  ) +
  labs(
    x = "Hours post-fertilization", y = "Viable embryo counts",
    title = "Survival"
  ) +
  geom_hline(yintercept = 30, linetype = "dashed") +
  scale_y_continuous(
    limits = c(0, 34), breaks = c(0, 10, 20, 30),
    sec.axis = sec_axis(~ . / 30 * 100, name = "Percent relative survival",
                        breaks = seq(0, 100, 10),
                        labels = scales::label_number(accuracy = 1, suffix = "%"))
  ) +
  theme_sleek_axe() +
  theme(
    axis.ticks.x = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    #legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.title.position = "top",
    plot.title = element_text(size = 14)
  )

survival
```
```{r}
ggsave("../figs/embryo_survival_box.png", width = 8, height = 6, dpi = 600)
```


# Timing barplot

# Stacked barplot

```{r}
prop_summary <- prop_summary %>% 
  mutate(
    treatment = factor(treatment, levels = treat_levels, ordered = TRUE),
    stage     = factor(stage, levels = c("egg", "cleavage", "morula", "prawnchip", "earlygastrula"), ordered = TRUE),
    hpf       = factor(hpf, levels = hpf_levels, ordered = TRUE)
  )
```


```{r}
# Step 3: Plot
tick_map <- c(control = "control", low = "low",
              mid = "mid", high = "high")

timing <- prop_summary %>% 
ggplot(., aes(x = treatment, y = mean_prop*100, fill = stage)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = stage.5.colors) +
  ggtitle("Timing (stage composition)")+
  labs(y = "", x = "PVC Leachate", fill = "Embryonic stage") +
  scale_x_discrete(
    breaks = names(tick_map),  # control, low, mid, high
    labels = tick_map          # pretty labels you defined
  )+
  scale_y_continuous(
    expand = c(0, 0),   # << bars start flush at y = 0
    labels = scales::label_number(accuracy = 1, suffix = "%")  
    )+
  facet_wrap(~ hpf)+
  theme_sleek_axe()+
  theme(
    plot.title = element_text(margin = margin(b = 40)),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  )

timing
```
## Add pretty stage icons
```{r}
timing_pretty <- ggdraw(timing) + draw_image(image='svg/egg.png',
                        x=0.08, y=0.78, width=0.15, height=0.15)+
  draw_image(image='svg/cleavage.png',
                        x=0.205, y=0.78, width=0.15, height=0.15)+
  draw_image(image='svg/morula.png',
                        x=0.33, y=0.78, width=0.15, height=0.15)+
  draw_image(image='svg/prawnchip.png',
                        x=0.455, y=0.78, width=0.15, height=0.15)+
  draw_image(image='svg/earlygastrula.png',
                        x=0.58, y=0.78, width=0.15, height=0.15)

timing_pretty
```


```{r}
library(cowplot)
library(patchwork)

timing_pretty <- ggdraw() +
  draw_plot(timing, 0, 0, 1, 1) +   # base plot fills the whole panel
  draw_image('svg/egg.png',         x = 0.08,  y = 0.79, width = 0.15, height = 0.15) +
  draw_image('svg/cleavage.png',    x = 0.205, y = 0.79, width = 0.15, height = 0.15) +
  draw_image('svg/morula.png',      x = 0.33,  y = 0.79, width = 0.15, height = 0.15) +
  draw_image('svg/prawnchip.png',   x = 0.455, y = 0.79, width = 0.15, height = 0.15) +
  draw_image('svg/earlygastrula.png',
                                   x = 0.58,  y = 0.79, width = 0.15, height = 0.15)
timing_pretty
```

```{r}
ggsave("../figs/embryo_stage_stackedbar.png", width = 8, height = 6, dpi = 600)
```

# Abnormalities barplot


```{r}
status_summary <- status_summary %>%
  mutate(status = factor(status, levels = c("malformed", "uncertain", "typical"), 
                       ordered = TRUE),
         treatment = factor(treatment, levels = treat_levels, ordered = TRUE),
         hpf       = factor(hpf, levels = hpf_levels, ordered = TRUE))

abnormality <- ggplot(status_summary, aes(x = treatment, y = mean_prop*100, fill = status))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values = status.colors)+
  ggtitle("Abnormality (status composition)")+
  labs(y = "", x = "PVC Leachate", fill = "Embryonic status")+
  scale_x_discrete(
    labels = tick_map          # pretty labels you defined
  )+
  scale_y_continuous(
    expand = c(0, 0),   # << bars start flush at y = 0
    labels = scales::label_number(accuracy = 1, suffix = "%")
  )+
  facet_wrap(~ hpf)+
  theme_sleek_axe()+
  theme(
    #plot.title = element_text(margin = margin(b = 40)),
      axis.text.x = element_text(
      angle = 45,      # rotate 45Â°
      hjust = 1,       # horizontal justification
      vjust = 1        # tweak if you want
    ))

abnormality
```

```{r}
ggsave("../figs/embryo_status_stackedbar.png", width = 8, height = 6, dpi = 600)
```
# Patchwork 

## Add caption 
```{r}
cap_text <- paste(
  "A. Boxplot showing mean and individual counts of viable embryos at 4, 9, and 14 hours post-fertilization (hpf) following exposure to different doses of PVC leachate.",
  "B. Stacked barplot indicating the stage composition of samples at each treatment and timepoint.",
  "C. Stacked barplot indicating the status composition of samples at each treatment and timepoint.",
  sep = " "
)

# wrap to, say, 100 characters per line (tweak as needed)
cap_wrapped <- str_wrap(cap_text, width = 170)
```

## Patch it together

```{r, fig.height=12, fig.width=10}
# Wrap the cowplot/ggdraw object so patchwork can handle it properly
timing_wrapped <- wrap_elements(full = timing_pretty)

# Combine the three plots with survival on top and timing/abnormality on bottom
survival / (timing_wrapped | abnormality) +
  plot_layout(heights = c(1, 1)) 
  
```

```{r}
timingpretty <- timing_pretty + theme(aspect.ratio = 1)

timingpretty
```

```{r}
abnormality <- abnormality + theme(aspect.ratio = 3.6)
abnormality
```


```{r, fig.width = 12}
timingpretty + abnormality 
```

```{r}
# 1) Align B and C so their panels & outer sizes match
plots_bc <- align_plots(
  timingpretty,
  abnormality,
  align = "hv",   # align horizontally & vertically
  axis  = "tblr"  # align all axes
)

bc_row <- plot_grid(
  plots_bc[[1]],
  plots_bc[[2]],
  nrow = 1,
  rel_widths = c(1, 1)
)

plots_bc
bc_row

# 2) Put A on top, B+C row below with patchwork
final_fig <- survival_plot / wrap_elements(bc_row) +
  plot_layout(heights = c(2, 1)) +
  plot_annotation(
    title = "Embryo survival, developmental timing, and morphological status following PVC leachate exposure",
    tag_levels = "A"
  )

final_fig
```


```{r, fig.height=12, fig.width=10}
survival / (timingpretty | abnormality)+
  plot_annotation(
    title = "Embryo survival, developmental timing, and morphological status following PVC leachate exposure",
    tag_levels = "A",
    caption = cap_wrapped,
    theme = theme_sleek_axe() &
      theme(
        plot.tag = element_text(size = 10, 
                                colour = "grey50"),
        plot.caption = element_text(size   = 8,
                                colour = "grey30",
                                hjust  = 0.22,
                                margin = margin(t = 0, r = 0, b = 5, l = 0)),
        plot.title = element_text(
          size   = 16,
          color  = "grey40",
          hjust  = 0.5,    # center
          margin = margin(b = 30) # add space BELOW title
        )
      )
  )
```
save figure
```{r}
ggsave("../figs/figure_survival_timing_morphology.png", width = 10, height = 12, dpi = 600)
```

